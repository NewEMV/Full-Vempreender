<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Chat - Vempreender</title>
    <style>
        /* --- GERAL --- */
        :root {
            --whatsapp-bg: #e5ddd5;
            --header-bg: #f5f5f5;
            --primary-green: #075E54;
            --message-sent: #DCF8C6;
            --message-received: #fff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Evita barras de rolagem duplas */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--whatsapp-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-primary);
        }

        /* --- CONTAINER PRINCIPAL --- */
        .chat-container {
            width: 100%;
            height: 100%;
            background-color: var(--message-received);
            display: flex;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        @media (min-width: 769px) {
             .chat-container {
                width: 90%;
                max-width: 1200px;
                height: 95vh;
                max-height: 900px;
                border-radius: 5px;
            }
        }

        /* --- PAINEL ESQUERDO (LISTA DE CONTATOS) --- */
        .sidebar {
            width: 30%;
            min-width: 280px;
            background-color: var(--header-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 15px;
            background-color: var(--primary-green);
            color: white;
            font-weight: 500;
        }

        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .chat-list-item.active {
            background-color: #e0e0e0;
        }

        .chat-list-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            background-color: #ccc; /* Cor de fundo para avatares vazios */
        }

        .chat-info h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }

        .chat-info p {
            margin: 0;
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- PAINEL DIREITO (JANELA DE CHAT) --- */
        .chat-window {
            width: 70%;
            display: flex;
            flex-direction: column;
            background-color: var(--whatsapp-bg);
            /* Imagem de fundo do WhatsApp em base64 para evitar requisições externas */
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABJJREFUeNpiZGBg6AGAgADT/xEgAAEGADQiAcyGk8nRAAAAAElFTkSuQmCC');
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .chat-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            background-color: #ccc; /* Cor de fundo para avatares vazios */
        }

        .chat-header h4 {
            margin: 0;
            font-weight: 500;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            word-wrap: break-word;
        }

        .message .text {
            font-size: 15px;
            white-space: pre-wrap; /* Essencial para respeitar as quebras de linha */
        }

        .message .timestamp {
            font-size: 11px;
            color: #999;
            align-self: flex-end;
            margin-top: 5px;
        }
        
        .message.sent {
            background-color: var(--message-sent);
            align-self: flex-end;
        }
        
        .message.sent .timestamp {
            color: #6aaa96;
        }

        .message.received {
            background-color: var(--message-received);
            align-self: flex-start;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        
        .message#typing-indicator .text{
            font-style: italic;
            color: #888;
        }

        /* --- ÁREA DE INPUT AJUSTADA --- */
        .chat-input-area {
            padding: 10px 20px;
            background-color: var(--header-bg);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0; /* Impede que a área de input encolha */
        }

        #message-form {
            display: flex;
            align-items: flex-end; /* Alinha na base para o botão acompanhar o textarea */
            width: 100%;
        }

        #message-input { /* Agora é um TEXTAREA */
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 15px;
            outline: none;
            resize: none; /* Desabilita o redimensionamento manual */
            overflow-y: auto; /* Adiciona scroll se o texto for muito grande */
            max-height: 120px; /* Limita a altura máxima */
            line-height: 1.5;
            font-family: inherit;
        }

        #send-button {
            background-color: var(--primary-green);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        #send-button svg {
            width: 24px;
            height: 24px;
        }
        
        #send-button:disabled {
            background-color: #a5d6a7;
            cursor: wait;
        }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .chat-window {
                width: 100%;
            }
             .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>

    <div class="chat-container">
        <aside class="sidebar">
            <header class="sidebar-header">
                <h3>Chats</h3>
            </header>
            <div class="chat-list">
                <div class="chat-list-item active">
                    <img src="" alt="Avatar" id="chatbot-avatar-sidebar">
                    <div class="chat-info">
                        <h4 id="chatbot-name-sidebar">Carregando...</h4>
                        <p>Olá! Como posso ajudar hoje?</p>
                    </div>
                </div>
            </div>
        </aside>

        <main class="chat-window">
            <header class="chat-header">
                <img src="" alt="Avatar" id="chatbot-avatar-header">
                <h4 id="chatbot-name-header">Carregando...</h4>
            </header>
            <div class="chat-messages" id="chat-messages">
                </div>

            <footer class="chat-input-area">
                <form id="message-form">
                    <textarea id="message-input" placeholder="Digite uma mensagem..." rows="1"></textarea>
                    <button type="submit" id="send-button" title="Enviar Mensagem">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"></path>
                        </svg>
                    </button>
                </form>
            </footer>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const chatMessages = document.getElementById('chat-messages');
            const sendButton = document.getElementById('send-button');

            // --- INÍCIO: LÓGICA DE PERSONALIZAÇÃO COM FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyB3STvFlyzwm95CgGjJU5kQbWmAc8j6jpY", // Sua chave de API
                authDomain: "cb-vempreender.firebaseapp.com",
                projectId: "cb-vempreender",
                storageBucket: "cb-vempreender.appspot.com",
                messagingSenderId: "826670588256",
                appId: "1:826670588256:web:1d180e4a246b86c8e47e05",
                measurementId: "G-RM7VP482DE"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id');

            async function fetchChatbotProfile(id) {
                if (!id) return;
                
                const docRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${id}/chatbotForm/data`);
                
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const nomeEmpresa = data.nomeEmpresa || 'Atendente Virtual';
                        const profilePicUrl = data.fotoPerfilUrl || 'https://i.pravatar.cc/150?u=vempreender';

                        document.getElementById('chatbot-name-header').textContent = nomeEmpresa;
                        document.getElementById('chatbot-avatar-header').src = profilePicUrl;
                        document.getElementById('chatbot-name-sidebar').textContent = nomeEmpresa;
                        document.getElementById('chatbot-avatar-sidebar').src = profilePicUrl;

                    } else {
                        console.warn("Documento de configuração do chatbot não encontrado.");
                        document.getElementById('chatbot-name-header').textContent = 'Atendente Virtual';
                        document.getElementById('chatbot-name-sidebar').textContent = 'Atendente Virtual';
                    }
                } catch (error) {
                    console.error("Erro ao buscar perfil do chatbot:", error);
                    document.getElementById('chatbot-name-header').textContent = 'Erro de Conexão';
                    document.getElementById('chatbot-name-sidebar').textContent = 'Erro de Conexão';
                }
            }
            
            // --- FIM: LÓGICA DE PERSONALIZAÇÃO COM FIREBASE ---

            if (!userId) {
                addMessageToChat('received', 'ERRO: O link deste chat é inválido. Não foi possível identificar o chatbot correto.');
                sendButton.disabled = true;
                messageInput.disabled = true;
                return;
            }
            
            // Personaliza a interface antes de qualquer outra ação
            await fetchChatbotProfile(userId);

            const mainWebhookUrl = 'https://webhook.escalarminhasvendas.com.br/webhook/cb_vempreender_wf02_v3';
            // URL CORRETA DO WEBHOOK DE SAUDAÇÃO
            const greetingWebhookUrl = 'https://webhook.escalarminhasvendas.com.br/webhook/saudacao';

            let conversationId = localStorage.getItem('vempreender_conversation_id');
            const isNewConversation = !conversationId;

            if (isNewConversation) {
                conversationId = 'lead_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('vempreender_conversation_id', conversationId);
            }

            messageInput.focus();
            
            // --- LÓGICA PARA CHAMAR A SAUDAÇÃO ---
            if (isNewConversation) {
                fetchGreeting();
            }

            // --- LÓGICA DO FORMULÁRIO ---
            messageForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const userMessage = messageInput.value.trim();
                if(userMessage){
                    sendMessageToN8N(userMessage);
                    messageInput.value = '';
                    messageInput.style.height = 'auto'; // Reseta a altura do input após enviar
                }
            });
            
            // --- FUNÇÕES ---
            function fetchGreeting() {
                addTypingIndicator();
                const dataToSend = { contactId: userId, conversationId: conversationId };

                fetch(greetingWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend),
                })
                .then(response => {
                    if (!response.ok) return Promise.reject(new Error(`Failed to fetch (${response.status})`));
                    return response.json();
                })
                .then(data => {
                    removeTypingIndicator();
                    addMessageToChat('received', data.reply || 'Olá! Como posso ajudar?');
                })
                .catch(error => {
                    removeTypingIndicator();
                    console.error('Falha ao buscar saudação:', error);
                    addMessageToChat('received', `Desculpe, ocorreu um erro de comunicação. (${error.message})`);
                });
            }

            function sendMessageToN8N(messageText) {
                addMessageToChat('sent', messageText);
                const dataToSend = { text: messageText, sender: 'user', contactId: userId, conversationId: conversationId };
                sendButton.disabled = true;
                addTypingIndicator();

                fetch(mainWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend),
                })
                .then(response => response.ok ? response.json() : Promise.reject(response))
                .then(data => {
                    removeTypingIndicator();
                    if (data && data.reply) {
                        addMessageToChat('received', data.reply);
                    } else {
                        addMessageToChat('received', 'Não entendi a resposta do servidor. Verifique o nó "Respond to Webhook" no n8n.');
                    }
                })
                .catch(error => {
                    removeTypingIndicator();
                    console.error('Falha ao comunicar com o webhook principal:', error);
                    addMessageToChat('received', `Desculpe, ocorreu um erro de comunicação. Tente novamente mais tarde.`);
                })
                .finally(() => {
                    sendButton.disabled = false;
                    messageInput.focus();
                });
            }

            function addMessageToChat(type, text) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', type);
                const now = new Date();
                const timestamp = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                const textElement = document.createElement('span');
                textElement.classList.add('text');
                textElement.textContent = text;

                const timestampElement = document.createElement('span');
                timestampElement.classList.add('timestamp');
                timestampElement.textContent = timestamp;

                messageElement.appendChild(textElement);
                messageElement.appendChild(timestampElement);
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function addTypingIndicator() {
                if (document.getElementById('typing-indicator')) return;
                const typingElement = document.createElement('div');
                typingElement.classList.add('message', 'received');
                typingElement.id = 'typing-indicator';
                typingElement.innerHTML = `<span class="text">Digitando...</span>`;
                chatMessages.appendChild(typingElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function removeTypingIndicator() {
                const typingElement = document.getElementById('typing-indicator');
                if (typingElement) {
                    typingElement.remove();
                }
            }
            
            // Lógica do Textarea auto-ajustável
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            });

            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    messageForm.dispatchEvent(new Event('submit', { cancelable: true }));
                }
            });
        });
    </script>

</body>
</html>